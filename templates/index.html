{% extends "base.html" %}

{% block content %}
<div x-data="{ 
  showForm: false,
  showModal: false,
  modalMode: 'view',
  currentPrompt: null,
  promptChanged: false,
  importLoading: false,
  
  openModal(promptId) {
    this.promptChanged = false;
    // Fetch full prompt data via HTMX
    fetch(`/prompts/${promptId}/modal`)
      .then(response => response.json())
      .then(data => {
        this.currentPrompt = data;
        this.modalMode = 'view';
        this.showModal = true;
        document.body.style.overflow = 'hidden';
        // Load notes into modal
        this.loadModalContent(promptId);
      });
  },
  
  closeModal() {
    // Refresh the card if changes were made
    if (this.promptChanged && this.currentPrompt?.id) {
      htmx.ajax('GET', `/prompts/${this.currentPrompt.id}/card`, {
        target: `#prompt-${this.currentPrompt.id}`,
        swap: 'outerHTML'
      });
    }
    this.showModal = false;
    this.currentPrompt = null;
    this.modalMode = 'view';
    this.promptChanged = false;
    document.body.style.overflow = '';
  },
  
  toggleEdit() {
    this.modalMode = this.modalMode === 'view' ? 'edit' : 'view';
  },
  
  async submitPromptEdit(event) {
    const form = event.target;
    const formData = new FormData(form);
    const promptId = this.currentPrompt?.id;
    if (!promptId) return;
    
    const response = await fetch(`/prompts/${promptId}`, {
      method: 'PUT',
      body: formData
    });
    const html = await response.text();
    // Update the card in the background
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    const newCard = tempDiv.firstElementChild;
    const oldCard = document.getElementById(`prompt-${promptId}`);
    if (oldCard && newCard) {
      oldCard.replaceWith(newCard);
      htmx.process(newCard);
    }
    // Update modal data
    const updatedData = await fetch(`/prompts/${promptId}/modal`).then(r => r.json());
    this.currentPrompt = updatedData;
    this.modalMode = 'view';
    this.promptChanged = true;
  },
  
  loadModalContent(promptId) {
    // Load notes section via HTMX
    htmx.ajax('GET', `/prompts/${promptId}/notes-list`, {
      target: '#modal-notes-list',
      swap: 'outerHTML'
    });
  },
  
  async handleImport(event) {
    const file = event.target.files?.[0];
    if (!file) return;
    
    this.importLoading = true;
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      const response = await fetch('/prompts/import', {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) {
        const html = await response.text();
        document.getElementById('prompts-list').innerHTML = html;
        htmx.process(document.getElementById('prompts-list'));
        event.target.value = ''; // Reset file input
      } else {
        const error = await response.json();
        alert('Import failed: ' + (error.detail || 'Unknown error'));
      }
    } catch (error) {
      alert('Import failed: ' + error.message);
    } finally {
      this.importLoading = false;
    }
  }
}" 
@keydown.escape.window="showModal && closeModal()">
    <!-- Hero Section -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Your AI Prompts</h2>
        <p class="text-gray-600">Manage and organize your AI prompts in one place</p>
    </div>

    <!-- Add New Prompt and Import Buttons -->
    <div class="mb-6 flex justify-between items-center">
        <button 
            @click="showForm = !showForm"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-sm"
        >
            <span x-show="!showForm">+ Add New Prompt</span>
            <span x-show="showForm">Cancel</span>
        </button>
        
        <label class="cursor-pointer">
            <input 
                type="file" 
                accept=".json,application/json"
                @change="handleImport($event)"
                class="hidden"
                :disabled="importLoading"
            >
            <span 
                class="inline-flex items-center gap-2 border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-semibold py-2 px-4 rounded-lg transition duration-200"
                :class="importLoading ? 'opacity-50 cursor-not-allowed' : ''"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                <span x-show="!importLoading">Import JSON</span>
                <span x-show="importLoading">Importing...</span>
            </span>
        </label>
    </div>

    <!-- Create Form -->
    <div x-show="showForm" x-transition class="mb-8 bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Create New Prompt</h3>
        <form 
            x-data="{ loading: false }"
            hx-post="/prompts" 
            hx-target="#prompts-list"
            hx-swap="innerHTML"
            @htmx:before-request="loading = true"
            @htmx:after-request="loading = false; showForm = false; $event.target.reset()"
            class="space-y-4"
        >
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                <input 
                    type="text" 
                    id="title" 
                    name="title" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter prompt title"
                >
            </div>
            <div>
                <label for="content" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                <textarea 
                    id="content" 
                    name="content" 
                    required
                    rows="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter your prompt content"
                ></textarea>
            </div>
            <div class="flex gap-2">
                <button 
                    type="submit"
                    :disabled="loading"
                    :class="loading ? 'opacity-50 cursor-not-allowed' : ''"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200"
                >
                    <span x-show="!loading">Save Prompt</span>
                    <span x-show="loading">Saving...</span>
                </button>
                <button 
                    type="button"
                    @click="showForm = false"
                    :disabled="loading"
                    :class="loading ? 'opacity-50 cursor-not-allowed' : ''"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md transition duration-200"
                >
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Prompts List -->
    <div id="prompts-list">
        {% include "components/prompt_list.html" %}
    </div>
    
    <!-- Modal Component -->
    {% include "components/prompt_modal.html" %}
</div>
{% endblock %}
